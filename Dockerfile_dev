FROM jupyter/base-notebook:eb70bcf1a292
USER root

ARG netpyneuiBranch=development 
ENV netpyneuiBranch=${netpyneuiBranch}  
RUN echo "$netpyneuiBranch";

RUN apt-get -qq update
RUN apt-get install -y \
        locales \
        wget \
        gcc \
        g++ \
        build-essential \
        libncurses-dev \
        libpython-dev \
        cython \
        libx11-dev \
        git \
        bison \
        flex \
        automake \ 
        libtool \ 
        libxext-dev \
        libncurses-dev \
        python2.7-dev \
        xfonts-100dpi \ 
        libopenmpi-dev \
        make \
        zlib1g-dev \
        unzip \
        vim \
        libpng-dev

# Install latest iv and NEURON
RUN git clone --branch 7.6.1crxd https://github.com/adamjhn/nrn.git
WORKDIR nrn
RUN ./build.sh
RUN ./configure --without-x --with-nrnpython=python3 --without-paranrn --prefix="/home/jovyan/work/nrn/" --without-iv
RUN make --silent -j4
RUN make --silent install -j4

# Switch to non sudo, create a Python 3 virtual environment 
USER $NB_USER
# Commenting out the conda update things broke!
# RUN conda update conda
# python 3 implies python 3.7 at this moment in time. Probably we want to specify exactly the version
RUN conda create --name snakes python=3.5

# Install NEURON python
WORKDIR src/nrnpython
ENV PATH="/home/jovyan/work/nrn/x86_64/bin:${PATH}"
RUN /bin/bash -c "source activate snakes && python setup.py install"
# Install Bokeh
# I think this line breaks the previous conda installation
RUN /bin/bash -c "source activate snakes && conda install bokeh=0.12.7"


# Clone NetPyNE-UI and install the development version
WORKDIR ../../../
RUN wget https://github.com/MetaCell/NetPyNE-UI/archive/$netpyneuiBranch.zip
RUN unzip $netpyneuiBranch.zip
WORKDIR NetPyNE-UI-$netpyneuiBranch/utilities
RUN /bin/bash -c "source activate snakes && python --version"
RUN /bin/bash -c "source activate snakes && exec python install.py branch $netpyneuiBranch"
WORKDIR /home/jovyan
RUN git clone https://github.com/Neurosim-lab/netpyne_workspace
WORKDIR /home/jovyan/netpyne_workspace
CMD /bin/bash -c "source activate snakes && exec jupyter notebook --debug --NotebookApp.default_url=/geppetto --NotebookApp.token=''"
